// SPDX-License-Identifier: MIT
//
// Copyright (C)2020-2023 Daniel Bourdrez. All Rights Reserved.
//
// This source code is licensed under the MIT license found in the
// LICENSE file in the root directory of this source tree or at
// https://spdx.org/licenses/MIT.html

package group_test

import (
	"crypto"
	"testing"

	group "github.com/bytemare/crypto"
)

func testAll(t *testing.T, f func(*testGroup)) {
	for _, test := range testTable {
		t.Run(test.name, func(t *testing.T) {
			f(test)
		})
	}
}

var (
	testHashToGroupInput = []byte("input data")
	testHashToGroupDST   = []byte("domain separation tag")
)

type testHashToCurve struct {
	hashToScalar string
	hashToGroup  string
	input        []byte
	dst          []byte
}

// a testGroup references some parameters of a Group.
type testGroup struct {
	multBase      [15]string
	name          string
	h2c           string
	e2c           string
	basePoint     string
	basePointX    string
	identity      string
	fieldOrder    string
	hashToCurve   testHashToCurve
	elementLength int
	scalarLength  int
	group         group.Group
	hash          crypto.Hash
}

var testTable = []*testGroup{
	{
		[15]string{
			"e2f2ae0a6abc4e71a884a961c500515f58e30b6aa582dd8db6a65945e08d2d76",
			"6a493210f7499cd17fecb510ae0cea23a110e8d5b901f8acadd3095c73a3b919",
			"94741f5d5d52755ece4f23f044ee27d5d1ea1e2bd196b462166b16152a9d0259",
			"da80862773358b466ffadfe0b3293ab3d9fd53c5ea6c955358f568322daf6a57",
			"e882b131016b52c1d3337080187cf768423efccbb517bb495ab812c4160ff44e",
			"f64746d3c92b13050ed8d80236a7f0007c3b3f962f5ba793d19a601ebb1df403",
			"44f53520926ec81fbd5a387845beb7df85a96a24ece18738bdcfa6a7822a176d",
			"903293d8f2287ebe10e2374dc1a53e0bc887e592699f02d077d5263cdd55601c",
			"02622ace8f7303a31cafc63f8fc48fdc16e1c8c8d234b2f0d6685282a9076031",
			"20706fd788b2720a1ed2a5dad4952b01f413bcf0e7564de8cdc816689e2db95f",
			"bce83f8ba5dd2fa572864c24ba1810f9522bc6004afe95877ac73241cafdab42",
			"e4549ee16b9aa03099ca208c67adafcafa4c3f3e4e5303de6026e3ca8ff84460",
			"aa52e000df2e16f55fb1032fc33bc42742dad6bd5a8fc0be0167436c5948501f",
			"46376b80f409b29dc2b5f6f0c52591990896e5716f41477cd30085ab7f10301e",
			"e0c418f7c8d9c4cdd7395b93ea124f3ad99021bb681dfc3302a9d99a2e53e64e",
		},
		"Ristretto255",
		"ristretto255_XMD:SHA-512_R255MAP_RO_",
		"ristretto255_XMD:SHA-512_R255MAP_RO_",
		ristrettoBasePoint,
		ristrettoBasePoint,
		"0000000000000000000000000000000000000000000000000000000000000000",
		"57896044618658097711785492504343953926634992332820282019728792003956564819949",
		testHashToCurve{
			input:        testHashToGroupInput,
			dst:          testHashToGroupDST,
			hashToScalar: "7cf9410111022202c71f9d317d6fcd711a84fee5a406063f8376379bbe8a3f03",
			hashToGroup:  "d0f15a907366d66998784ff0148356bb0de24088680fb29d5fbe1a629d743b10",
		},
		32,
		32,
		1,
		crypto.SHA512,
	},
	{
		[15]string{
			"036b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296",
			"037cf27b188d034f7e8a52380304b51ac3c08969e277f21b35a60b48fc47669978",
			"025ecbe4d1a6330a44c8f7ef951d4bf165e6c6b721efada985fb41661bc6e7fd6c",
			"02e2534a3532d08fbba02dde659ee62bd0031fe2db785596ef509302446b030852",
			"0251590b7a515140d2d784c85608668fdfef8c82fd1f5be52421554a0dc3d033ed",
			"02b01a172a76a4602c92d3242cb897dde3024c740debb215b4c6b0aae93c2291a9",
			"028e533b6fa0bf7b4625bb30667c01fb607ef9f8b8a80fef5b300628703187b2a3",
			"0262d9779dbee9b0534042742d3ab54cadc1d238980fce97dbb4dd9dc1db6fb393",
			"02ea68d7b6fedf0b71878938d51d71f8729e0acb8c2c6df8b3d79e8a4b90949ee0",
			"03cef66d6b2a3a993e591214d1ea223fb545ca6c471c48306e4c36069404c5723f",
			"023ed113b7883b4c590638379db0c21cda16742ed0255048bf433391d374bc21d1",
			"03741dd5bda817d95e4626537320e5d55179983028b2f82c99d500c5ee8624e3c4",
			"02177c837ae0ac495a61805df2d85ee2fc792e284b65ead58a98e15d9d46072c01",
			"0354e77a001c3862b97a76647f4336df3cf126acbe7a069c5e5709277324d2920b",
			"02f0454dc6971abae7adfb378999888265ae03af92de3a0ef163668c63e59b9d5f",
		},
		"P256",
		"P256_XMD:SHA-256_SSWU_RO_",
		"P256_XMD:SHA-256_SSWU_NU_",
		"036b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296",
		"6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296",
		"000000000000000000000000000000000000000000000000000000000000000000",
		"115792089210356248762697446949407573530086143415290314195533631308867097853951",
		testHashToCurve{
			input:        testHashToGroupInput,
			dst:          testHashToGroupDST,
			hashToScalar: "4b51fd1148439c3a30539e87a2a75c63d72f71b74d108184beeb933d259456b9",
			hashToGroup:  "03536d17bf54e34ebc3926d425e76502b54bc2c393369fc6df0c729a18df667f4c",
		},
		33,
		32,
		3,
		crypto.SHA256,
	},
	{
		[15]string{
			"03aa87ca22be8b05378eb1c71ef320ad746e1d3b628ba79b9859f741e082542a385502f25dbf55296c3a545e3872760ab7",
			"0208d999057ba3d2d969260045c55b97f089025959a6f434d651d207d19fb96e9e4fe0e86ebe0e64f85b96a9c75295df61",
			"03077a41d4606ffa1464793c7e5fdc7d98cb9d3910202dcd06bea4f240d3566da6b408bbae5026580d02d7e5c70500c831",
			"03138251cd52ac9298c1c8aad977321deb97e709bd0b4ca0aca55dc8ad51dcfc9d1589a1597e3a5120e1efd631c63e1835",
			"0211de24a2c251c777573cac5ea025e467f208e51dbff98fc54f6661cbe56583b037882f4a1ca297e60abcdbc3836d84bc",
			"02627be1acd064d2b2226fe0d26f2d15d3c33ebcbb7f0f5da51cbd41f26257383021317d7202ff30e50937f0854e35c5df",
			"02283c1d7365ce4788f29f8ebf234edffead6fe997fbea5ffa2d58cc9dfa7b1c508b05526f55b9ebb2040f05b48fb6d0e1",
			"021692778ea596e0be75114297a6fa383445bf227fbe58190a900c3c73256f11fb5a3258d6f403d5ece6e9b269d822c87d",
			"028f0a39a4049bcb3ef1bf29b8b025b78f2216f7291e6fd3bac6cb1ee285fb6e21c388528bfee2b9535c55e4461079118b",
			"03a669c5563bd67eec678d29d6ef4fde864f372d90b79b9e88931d5c29291238cced8e85ab507bf91aa9cb2d13186658fb",
			"03099056e27da7b998da1eeec2904816c57fe935ed5837c37456c9fd14892d3f8c4749b66e3afb81d626356f3b55b4ddd8",
			"02952a7a349bd49289ab3ac421dcf683d08c2ed5e41f6d0e21648af2691a481406da4a5e22da817cb466da2ea77d2a7022",
			"02a567ba97b67aea5bafdaf5002ffcc6ab9632bff9f01f873f6267bcd1f0f11c139ee5f441abd99f1baaf1ca1e3b5cbce7",
			"02e8c8f94d44fbc2396bbeac481b89d2b0877b1dffd23e7dc95de541eb651cca2c41aba24dbc02de6637209accf0f59ea0",
			"02b3d13fc8b32b01058cc15c11d813525522a94156fff01c205b21f9f7da7c4e9ca849557a10b6383b4b88701a9606860b",
		},
		"P384",
		"P384_XMD:SHA-384_SSWU_RO_",
		"P384_XMD:SHA-384_SSWU_NU_",
		"03aa87ca22be8b05378eb1c71ef320ad746e1d3b628ba79b9859f741e082542a385502f25dbf55296c3a545e3872760ab7",
		"aa87ca22be8b05378eb1c71ef320ad746e1d3b628ba79b9859f741e082542a385502f25dbf55296c3a545e3872760ab7",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"39402006196394479212279040100143613805079739270465446667948293404245721771496870329047266088258938001861606973112319",
		testHashToCurve{
			input:        testHashToGroupInput,
			dst:          testHashToGroupDST,
			hashToScalar: "d22b5352caa675f8a2f385236b95cbc1f84b9e34540b3587d6d55bd5032bf51aeb54ccab701c6f05a489b82ec301012d",
			hashToGroup:  "02777ff137e17b48ab4984de510461af79cf34609ac27f98eb2a4a553f94dbf31bf97b5cf7bac08f60bb8c7ee474a26202",
		},
		49,
		48,
		4,
		crypto.SHA384,
	},
	{
		[15]string{
			"0200c6858e06b70404e9cd9e3ecb662395b4429c648139053fb521f828af606b4d3dbaa14b5e77efe75928fe1dc127a2ffa8de3348b3c1856a429bf97e7e31c2e5bd66",
			"0200433c219024277e7e682fcb288148c282747403279b1ccc06352c6e5505d769be97b3b204da6ef55507aa104a3a35c5af41cf2fa364d60fd967f43e3933ba6d783d",
			"0301a73d352443de29195dd91d6a64b5959479b52a6e5b123d9ab9e5ad7a112d7a8dd1ad3f164a3a4832051da6bd16b59fe21baeb490862c32ea05a5919d2ede37ad7d",
			"030035b5df64ae2ac204c354b483487c9070cdc61c891c5ff39afc06c5d55541d3ceac8659e24afe3d0750e8b88e9f078af066a1d5025b08e5a5e2fbc87412871902f3",
			"0300652bf3c52927a432c73dbc3391c04eb0bf7a596efdb53f0d24cf03dab8f177ace4383c0c6d5e3014237112feaf137e79a329d7e1e6d8931738d5ab5096ec8f3078",
			"0301ee4569d6cdb59219532eff34f94480d195623d30977fd71cf3981506ade4ab01525fbcca16153f7394e0727a239531be8c2f66e95657f380ae23731bedf79206b9",
			"030056d5d1d99d5b7f6346eeb65fda0b073a0c5f22e0e8f5483228f018d2c2f7114c5d8c308d0abfc698d8c9a6df30dce3bbc46f953f50fdc2619a01cead882816ecd4",
			"02000822c40fb6301f7262a8348396b010e25bd4e29d8a9b003e0a8b8a3b05f826298f5bfea5b8579f49f08b598c1bc8d79e1ab56289b5a6f4040586f9ea54aa78ce68",
			"0201585389e359e1e21826a2f5bf157156d488ed34541b988746992c4ab145b8c6b6657429e1396134da35f3c556df725a318f4f50babd85cd28661f45627967cbe207",
			"030190eb8f22bda61f281dfcfe7bb6721ec4cd901d879ac09ac7c34a9246b11ada8910a2c7c178fcc263299daa4da9842093f37c2e411f1a8e819a87ff09a04f2f3320",
			"02008a75841259fdedff546f1a39573b4315cfed5dc7ed7c17849543ef2c54f2991652f3dbc5332663da1bd19b1aebe3191085015c024fa4c9a902ecc0e02dda0cdb9a",
			"0201c0d9dcec93f8221c5de4fae9749c7fde1e81874157958457b6107cf7a5967713a644e90b7c3fb81b31477fee9a60e938013774c75c530928b17be69571bf842d8c",
			"03007e3e98f984c396ad9cd7865d2b4924861a93f736cde1b4c2384eedd2beaf5b866132c45908e03c996a3550a5e79ab88ee94bec3b00ab38eff81887848d32fbcda7",
			"0201875bc7dc551b1b65a9e1b8ccfaaf84ded1958b401494116a2fd4fb0babe0b3199974fc06c8b897222d79df3e4b7bc744aa6767f6b812efbf5d2c9e682dd3432d74",
			"03006b6ad89abcb92465f041558fc546d4300fb8fbcc30b40a0852d697b532df128e11b91cce27dbd00ffe7875bd1c8fc0331d9b8d96981e3f92bde9afe337bcb8db55",
		},
		"P521",
		"P521_XMD:SHA-512_SSWU_RO_",
		"P521_XMD:SHA-512_SSWU_NU_",
		"0200c6858e06b70404e9cd9e3ecb662395b4429c648139053fb521f828af606b4d3dbaa14b5e77efe75928fe1dc127a2ffa8de3348b3c1856a429bf97e7e31c2e5bd66",
		"00c6858e06b70404e9cd9e3ecb662395b4429c648139053fb521f828af606b4d3dbaa14b5e77efe75928fe1dc127a2ffa8de3348b3c1856a429bf97e7e31c2e5bd66",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"6864797660130609714981900799081393217269435300143305409394463459185543183397656052122559640661454554977296311391480858037121987999716643812574028291115057151",
		testHashToCurve{
			input:        testHashToGroupInput,
			dst:          testHashToGroupDST,
			hashToScalar: "01f4e5806586dbebd01e85b17da1eb2df4ac678bc8683b9baa5dd5fba6a0f9d1ff5621ed342a90273150fd095c7abc07f97d202183ec804d063b9fcc0b95daec0614",
			hashToGroup:  "0300d24ae26cefe28681d4cf35cf7bea7de3acd15f38ba0b835303c9cdc641d1912566041cb5f6939ad43f0b21e506cecc4a8124a0517dce94f2f1affa47f052f25bf0",
		},
		67,
		66,
		5,
		crypto.SHA512,
	},
	{
		[15]string{
			"5866666666666666666666666666666666666666666666666666666666666666",
			"c9a3f86aae465f0e56513864510f3997561fa2c9e85ea21dc2292309f3cd6022",
			"d4b4f5784868c3020403246717ec169ff79e26608ea126a1ab69ee77d1b16712",
			"2f1132ca61ab38dff00f2fea3228f24c6c71d58085b80e47e19515cb27e8d047",
			"edc876d6831fd2105d0b4389ca2e283166469289146e2ce06faefe98b22548df",
			"f47e49f9d07ad2c1606b4d94067c41f9777d4ffda709b71da1d88628fce34d85",
			"b862409fb5c4c4123df2abf7462b88f041ad36dd6864ce872fd5472be363c5b1",
			"b4b937fca95b2f1e93e41e62fc3c78818ff38a66096fad6e7973e5c90006d321",
			"c0f1225584444ec730446e231390781ffdd2f256e9fcbeb2f40dddc2c2233d7f",
			"2c7be86ab07488ba43e8e03d85a67625cfbf98c8544de4c877241b7aaafc7fe3",
			"1337036ac32d8f30d4589c3c1c595812ce0fff40e37c6f5a97ab213f318290ad",
			"f9e42d2edc81d23367967352b47e4856b82578634e6c1de72280ce8b60ce70c0",
			"801f40eaaee1ef8723279a28b2cf4037b889dad222604678748b53ed0db0db92",
			"39289c8998fd69835c26b619e89848a7bf02b7cb7ad1ba1581cbc4506f2550ce",
			"df5c2eadc44c6d94a19a9aa118afe5ac3193d26401f76251f522ff042dfbcb92",
		},
		"Edwards25519",
		"edwards25519_XMD:SHA-512_ELL2_RO_",
		"edwards25519_XMD:SHA-512_ELL2_NU_",
		"5866666666666666666666666666666666666666666666666666666666666666",
		"0900000000000000000000000000000000000000000000000000000000000000",
		"0100000000000000000000000000000000000000000000000000000000000000",
		"57896044618658097711785492504343953926634992332820282019728792003956564819949",
		testHashToCurve{
			input:        testHashToGroupInput,
			dst:          testHashToGroupDST,
			hashToScalar: "90249f56fa61b29fc09b8787d9954a6beba6ca49e25c80f78560ca5458e5b807",
			hashToGroup:  "a2ca6693cdda5b8d204a506fe873ce1d3e58d5b14d04635e13c10ba9d5637f8f",
		},
		32,
		32,
		6,
		crypto.SHA512,
	},
	{
		[15]string{
			"0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798",
			"02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5",
			"02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9",
			"02e493dbf1c10d80f3581e4904930b1404cc6c13900ee0758474fa94abe8c4cd13",
			"022f8bde4d1a07209355b4a7250a5c5128e88b84bddc619ab7cba8d569b240efe4",
			"03fff97bd5755eeea420453a14355235d382f6472f8568a18b2f057a1460297556",
			"025cbdf0646e5db4eaa398f365f2ea7a0e3d419b7e0330e39ce92bddedcac4f9bc",
			"022f01e5e15cca351daff3843fb70f3c2f0a1bdd05e5af888a67784ef3e10a2a01",
			"03acd484e2f0c7f65309ad178a9f559abde09796974c57e714c35f110dfc27ccbe",
			"03a0434d9e47f3c86235477c7b1ae6ae5d3442d49b1943c2b752a68e2a47e247c7",
			"03774ae7f858a9411e5ef4246b70c65aac5649980be5c17891bbec17895da008cb",
			"03d01115d548e7561b15c38f004d734633687cf4419620095bc5b0f47070afe85a",
			"03f28773c2d975288bc7d1d205c3748651b075fbc6610e58cddeeddf8f19405aa8",
			"03499fdf9e895e719cfd64e67f07d38e3226aa7b63678949e6e49b241a60e823e4",
			"02d7924d4f7d43ea965a465ae3095ff41131e5946f3c85f79e44adbcf8e27e080e",
		},
		"Secp256k1",
		"secp256k1_XMD:SHA-256_SSWU_RO_",
		"secp256k1_XMD:SHA-256_SSWU_NU_",
		"0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798",
		"79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798",
		"000000000000000000000000000000000000000000000000000000000000000000",
		"115792089237316195423570985008687907853269984665640564039457584007908834671663",
		testHashToCurve{
			input:        testHashToGroupInput,
			dst:          testHashToGroupDST,
			hashToScalar: "782a63d48eace435ac06468208d9a62e3680e4ddc3977c4345b2c6de08258b69",
			hashToGroup:  "0210dca4244e263298000ff1e9f0dfbf1c28333e1f0a252024e8b20b9921cdf3b2",
		},
		33,
		32,
		7,
		crypto.SHA256,
	},
}
